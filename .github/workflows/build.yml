name: Build and Release ShiftSwitch

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

# æ·»åŠ æƒé™è®¾ç½®
permissions:
  contents: write
  packages: write

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
        
    - name: Show Xcode version
      run: xcodebuild -version
      
    - name: Clean build directory
      run: |
        rm -rf build
        mkdir -p build
        
    - name: Build ShiftSwitch
      run: |
        xcodebuild -scheme ShiftSwitch \
          -configuration Release \
          -derivedDataPath ./build \
          clean build \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO
          
    - name: Verify build output
      run: |
        ls -la ./build/Build/Products/Release/
        file ./build/Build/Products/Release/ShiftSwitch.app/Contents/MacOS/ShiftSwitch
        
    - name: Self-sign application (Ad-hoc)
      run: |
        echo "ğŸ” å¼€å§‹è¿›è¡Œad-hocä»£ç ç­¾å..."
        APP_PATH="./build/Build/Products/Release/ShiftSwitch.app"
        
        if [ -d "$APP_PATH" ]; then
          # æ˜¾ç¤ºåŸå§‹ç­¾åçŠ¶æ€
          echo "ğŸ“‹ åŸå§‹ç­¾åçŠ¶æ€:"
          codesign -dv "$APP_PATH" || echo "æœªç­¾å"
          
          # æ‰§è¡Œad-hocç­¾å
          codesign --force --deep --sign - "$APP_PATH"
          echo "âœ… Ad-hocç­¾åå®Œæˆ"
          
          # éªŒè¯ç­¾å
          echo "ğŸ” éªŒè¯ç­¾å:"
          codesign --verify --verbose "$APP_PATH"
          
          # æ˜¾ç¤ºç­¾åä¿¡æ¯
          echo "ğŸ“œ ç­¾åä¿¡æ¯:"
          codesign -dv "$APP_PATH"
          
          echo "âœ… åº”ç”¨å·²å®Œæˆad-hocç­¾åï¼Œå¯ä»¥åœ¨æœ¬åœ°macOSä¸Šè¿è¡Œ"
        else
          echo "âŒ æœªæ‰¾åˆ°åº”ç”¨æ–‡ä»¶: $APP_PATH"
          ls -la ./build/Build/Products/Release/
          exit 1
        fi
        
    - name: Create DMG
      run: |
        # å®‰è£… create-dmg
        brew install create-dmg
        
        # åˆ›å»º DMG å®‰è£…åŒ…
        create-dmg \
          --volname "ShiftSwitch" \
          --volicon "./ShiftSwitch/Assets.xcassets/AppIcon.appiconset/icon_256x256.png" \
          --window-pos 200 120 \
          --window-size 600 400 \
          --icon-size 100 \
          --icon "ShiftSwitch.app" 200 190 \
          --hide-extension "ShiftSwitch.app" \
          --app-drop-link 400 190 \
          "./build/ShiftSwitch.dmg" \
          "./build/Build/Products/Release/ShiftSwitch.app" || \
        create-dmg \
          --volname "ShiftSwitch" \
          --window-pos 200 120 \
          --window-size 600 400 \
          --icon-size 100 \
          --app-drop-link 400 190 \
          "./build/ShiftSwitch.dmg" \
          "./build/Build/Products/Release/ShiftSwitch.app"
          
    - name: Create ZIP archive
      run: |
        cd ./build/Build/Products/Release/
        zip -r ../../../../build/ShiftSwitch.zip ShiftSwitch.app
        cd ../../../../
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ShiftSwitch-${{ github.sha }}
        path: |
          ./build/ShiftSwitch.dmg
          ./build/ShiftSwitch.zip
        retention-days: 30
        
    - name: Get version info
      id: version
      run: |
        if [[ $GITHUB_REF == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/}
        else
          VERSION="dev-$(date +'%Y%m%d')-${GITHUB_SHA::8}"
        fi
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "Version: $VERSION"
        
    - name: Create Release (on tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v2
      with:
        name: ShiftSwitch ${{ steps.version.outputs.VERSION }}
        tag_name: ${{ steps.version.outputs.VERSION }}
        body: |
          ## ShiftSwitch ${{ steps.version.outputs.VERSION }}
          
          ### åŠŸèƒ½ç‰¹ç‚¹
          - âœ… **Shifté”®åˆ‡æ¢è¾“å…¥æ³•**ï¼šå•ç‹¬æŒ‰ä¸‹å·¦æˆ–å³Shifté”®å¿«é€Ÿåˆ‡æ¢ä¸­è‹±æ–‡è¾“å…¥æ³•
          - âœ… **Caps Lockçº¯å¤§å°å†™**ï¼šCaps Locké”®åªæ§åˆ¶è‹±æ–‡å­—æ¯å¤§å°å†™ï¼Œä¸åˆ‡æ¢è¾“å…¥æ³•
          - âœ… **æ™ºèƒ½è¾“å…¥æ³•è¯†åˆ«**ï¼šè‡ªåŠ¨æ£€æµ‹ç³»ç»Ÿå·²å¯ç”¨çš„ä¸­æ–‡å’Œè‹±æ–‡è¾“å…¥æ³•
          - âœ… **åå°è¿è¡Œ**ï¼šçŠ¶æ€æ èœå•ï¼Œä½èµ„æºå ç”¨
          - âœ… **æƒé™ç®¡ç†**ï¼šè‡ªåŠ¨æ£€æµ‹å’Œç”³è¯·è¾…åŠ©åŠŸèƒ½æƒé™
          
          ### ç³»ç»Ÿè¦æ±‚
          - macOS 15.3 (Sequoia) æˆ–æ›´é«˜ç‰ˆæœ¬
          - Apple Silicon æˆ– Intel å¤„ç†å™¨
          
          ### å®‰è£…æ–¹æ³•
          1. ä¸‹è½½ `ShiftSwitch.dmg` æ–‡ä»¶
          2. åŒå‡»æ‰“å¼€ï¼Œå°† ShiftSwitch.app æ‹–æ‹½åˆ°åº”ç”¨ç¨‹åºæ–‡ä»¶å¤¹
          3. é¦–æ¬¡è¿è¡Œæ—¶æˆäºˆè¾…åŠ©åŠŸèƒ½æƒé™
          
          ### ä½¿ç”¨æ–¹æ³•
          - å•ç‹¬æŒ‰ä¸‹Shifté”®ï¼ˆå·¦æˆ–å³ï¼‰åˆ‡æ¢ä¸­è‹±æ–‡è¾“å…¥æ³•
          - æŒ‰ä¸‹Caps Locké”®åªåˆ‡æ¢è‹±æ–‡å­—æ¯å¤§å°å†™
          - ç‚¹å‡»çŠ¶æ€æ âŒ¨ï¸å›¾æ ‡æŸ¥çœ‹èœå•é€‰é¡¹
          
        files: |
          ./build/ShiftSwitch.dmg
          ./build/ShiftSwitch.zip
        draft: false
        prerelease: false
        make_latest: true
        generate_release_notes: false
        fail_on_unmatched_files: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
  notarize:
    runs-on: macos-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: ShiftSwitch-${{ github.sha }}
        path: ./build/
        
    - name: Notarize app (if certificates available)
      if: env.APPLE_ID != '' && env.APPLE_PASSWORD != ''
      run: |
        echo "å…¬è¯åŠŸèƒ½éœ€è¦Appleå¼€å‘è€…è´¦æˆ·å’Œè¯ä¹¦"
        echo "å¦‚éœ€å…¬è¯ï¼Œè¯·è®¾ç½®ä»¥ä¸‹GitHub Secrets:"
        echo "- APPLE_ID: Apple ID"
        echo "- APPLE_PASSWORD: App-specific password"
        echo "- APPLE_TEAM_ID: Team ID"
        echo "- DEVELOPER_ID_APPLICATION: Developer ID Application certificate"
      env:
        APPLE_ID: ${{ secrets.APPLE_ID }}
        APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
        APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
